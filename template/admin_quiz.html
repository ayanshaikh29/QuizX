<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuizX | Manage Quizzes</title>
    <link rel="icon" type="image/png" 
      href="{{ url_for('static', filename='favicon.png') }}">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_quiz.css') }}">
</head>
<body>
<!-- This is a single-line comment -->
<div class="dashboard-wrapper">
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo">
            <img src="{{ url_for('static', filename='logo.png') }}"
            alt="QuizX Logo"
            style="height:80px;">
        </div>
        <nav class="sidebar-nav">
            <a href="{{ url_for('admin.dashboard') }}" class="nav-link"><i class="fas fa-th-large"></i> Dashboard</a>
            <a href="{{ url_for('admin.quizzes') }}" class="nav-link active"><i class="fas fa-book"></i> Quizzes</a>
            <a href="{{ url_for('admin.quizzes') }}" class="nav-link"><i class="fas fa-chart-line"></i> Analytics</a>
            <a href="{{ url_for('auth.profile') }}" class="nav-link"><i class="fas fa-user-circle"></i> Profile</a>
        </nav>
        <div class="sidebar-footer">
            <a href="{{ url_for('auth.logout') }}" class="logout-link"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </div>
    </aside>

    <main class="main-content">
        <header class="content-header">
            <div class="header-title">
                <h4 class="fw-bold mb-0">Quiz Management</h4>
                <small class="text-muted">Create and control your live assessments</small>
            </div>
            <div class="header-user">
                <img src="https://ui-avatars.com/api/?name={{ session.username }}&background=6fbf4a&color=fff" class="avatar" alt="Avatar">
            </div>
        </header>

        <div class="container-fluid p-4">
            <div class="create-quiz-box animate-slide-up">
                <div class="row align-items-center">
                    <div class="col-lg-4">
                        <h5 class="fw-bold mb-1"><i class="fas fa-plus-circle me-2 text-success"></i>Create New Quiz</h5>
                        <p class="text-muted small mb-0">Launch a new session in seconds.</p>
                    </div>
                    <div class="col-lg-8">
                        <form method="POST" action="{{ url_for('admin.quizzes') }}" class="row g-2">
                            <div class="col-md-5">
                                <input name="title" class="form-control custom-input" placeholder="Enter Quiz Title..." required>
                            </div>
                            <div class="col-md-4">
                                <select name="quiz_type" class="form-select custom-input" required>
                                    <option value="">Quiz Type...</option>
                                    <option value="normal">üìù Normal Quiz</option>
                                    <option value="timer">‚è±Ô∏è Timer-Based</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <button type="submit" class="btn btn-success-custom w-100">Create Quiz</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <ul class="nav nav-pills mb-4 animate-fade-in" id="quizTabs" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#normal-quizzes">
                        <i class="fas fa-file-alt me-2"></i>Normal Quizzes
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="pill" data-bs-target="#timer-quizzes">
                        <i class="fas fa-stopwatch me-2"></i>Timer-Based
                    </button>
                </li>
            </ul>

            <div class="tab-content mt-2">
                <div class="tab-pane fade show active" id="normal-quizzes">
                    <div class="row g-4">
                        {% set normal_quizzes = quizzes | selectattr('has_timer', 'equalto', False) | list %}
                        {% if normal_quizzes %}
                            {% for q in normal_quizzes %}
                            <div class="col-xl-4 col-md-6 animate-slide-up">
                                <div class="quiz-card-pro">
                                    <div class="card-status">
                                        {% if q.is_active and q.is_paused %}<span class="status-pill paused">Paused</span>
                                        {% elif q.is_active %}<span class="status-pill live">Live</span>
                                        {% elif q.is_published %}<span class="status-pill ended">Ended</span>
                                        {% elif q.is_locked %}<span class="status-pill locked">Locked</span>
                                        {% else %}<span class="status-pill draft">Draft</span>{% endif %}
                                        
                                        <a href="{{ url_for('admin.delete_quiz', quiz_id=q.id) }}" class="ms-auto text-danger delete-icon" onclick="return confirm('Permanently delete this quiz?')">
                                            <i class="fas fa-trash-alt"></i>
                                        </a>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="quiz-name mb-0">{{ q.title }}</h5>
                                        <button class="btn btn-sm text-primary p-0 ms-2" onclick="renameQuiz('{{ q.id }}', '{{ q.title }}')">
                                            <i class="fas fa-pen-to-square"></i>
                                        </button>
                                    </div>

                                    <div class="quiz-info">
                                        <div class="info-item"><i class="fas fa-calendar-alt"></i><span>{% if q.published_at %}{{ q.published_at.strftime('%d %b, %H:%M') }}{% else %}Not Started{% endif %}</span></div>
                                        <div class="info-item"><i class="fas fa-sync"></i><span>Publishes: {{ q.publish_count }}</span></div>
                                    </div>

                                    {% if q.is_active and q.join_code %}
                                    <div class="join-area-pro mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="code-box">
                                                <small>Join Code</small>
                                                <strong id="code-{{ q.id }}">{{ q.join_code }}</strong>
                                            </div>
                                            <button class="btn btn-sm copy-btn" onclick="copyJoinLink('{{ request.host_url }}join/{{ q.join_code }}')">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                        <a href="{{ request.host_url }}join/{{ q.join_code }}"
                                           target="_blank"
                                           class="join-link">
                                            {{ request.host_url }}join/{{ q.join_code }}
                                        </a>
                                    </div>
                                    {% endif %}

                                    <div class="card-actions">
                                        {% if q.is_published or q.is_active %}
                                            <a href="{{ url_for('admin.analytics', quiz_id=q.id) }}" class="btn action-btn text-dark w-100 mb-2" style="background-color: #f8f9fa; border: 1px solid #ddd;">
                                                <i class="fas fa-chart-bar me-2"></i>View Analytics
                                            </a>
                                        {% endif %}

                                        {% if q.is_active %}
                                            <a href="{{ url_for('admin.live_control', quiz_id=q.id) }}" class="btn action-btn btn-danger text-white w-100 mb-2">
                                                <i class="fas fa-broadcast-tower me-2"></i>üî¥ LIVE CONTROL
                                            </a>
                                            <a href="{{ url_for('admin.stop_quiz', quiz_id=q.id) }}" class="btn action-btn stop"><i class="fas fa-stop"></i> Stop</a>
                                        {% endif %}

                                        {% if not q.is_locked and not q.is_active and not q.is_published %}
                                            <a href="{{ url_for('admin.add_question', quiz_id=q.id) }}" class="btn action-btn edit"><i class="fas fa-edit"></i> Edit</a>
                                        {% endif %}

                                        {% if q.is_locked and not q.is_published and not q.is_active %}
                                            <a href="{{ url_for('admin.publish_quiz', quiz_id=q.id) }}" class="btn action-btn start"><i class="fas fa-play"></i> Publish</a>
                                        {% endif %}

                                        {% if q.is_published and not q.is_active %}
                                            <a href="{{ url_for('admin.start_quiz', quiz_id=q.id) }}" class="btn action-btn text-white w-100" style="background-color: #fd7e14;" onclick="return confirm('Are you sure you want to start this quiz for all students?')">
                                                <i class="fas fa-play me-2"></i>Start Quiz
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center p-5 w-100">
                                <p class="text-muted">No normal quizzes found.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <div class="tab-pane fade" id="timer-quizzes">
                    <div class="row g-4">
                        {% set timer_quizzes = quizzes | selectattr('has_timer', 'equalto', True) | list %}
                        {% if timer_quizzes %}
                            {% for q in timer_quizzes %}
                            <div class="col-xl-4 col-md-6 animate-slide-up">
                                <div class="quiz-card-pro timer-border">
                                    <div class="card-status">
                                        {% if q.is_active %}<span class="status-pill live">Live</span>
                                        {% elif q.is_published %}<span class="status-pill ended">Ended</span>
                                        {% else %}<span class="status-pill timer">Timer-Based</span>{% endif %}
                                        
                                        <a href="{{ url_for('admin.delete_quiz', quiz_id=q.id) }}" class="ms-auto text-danger delete-icon" onclick="return confirm('Permanently delete this quiz?')">
                                            <i class="fas fa-trash-alt"></i>
                                        </a>
                                    </div>
                                    
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h5 class="quiz-name mb-0">{{ q.title }}</h5>
                                        <button class="btn btn-sm text-primary p-0 ms-2" onclick="renameQuiz('{{ q.id }}', '{{ q.title }}')">
                                            <i class="fas fa-pen-to-square"></i>
                                        </button>
                                    </div>

                                    <div class="quiz-info">
                                        <div class="info-item"><i class="fas fa-calendar-alt"></i><span>{% if q.published_at %}{{ q.published_at.strftime('%d %b, %H:%M') }}{% else %}Not Started{% endif %}</span></div>
                                    </div>

                                    {% if q.is_active and q.join_code %}
                                    <div class="join-area-pro mb-3">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div class="code-box">
                                                <small>Join Code</small>
                                                <strong id="code-{{ q.id }}">{{ q.join_code }}</strong>
                                            </div>
                                            <button class="btn btn-sm copy-btn" onclick="copyJoinLink('{{ request.host_url }}join/{{ q.join_code }}')">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                        <a href="{{ request.host_url }}join/{{ q.join_code }}"
                                           target="_blank"
                                           class="join-link">
                                            {{ request.host_url }}join/{{ q.join_code }}
                                        </a>
                                    </div>
                                    {% endif %}

                                    <div class="card-actions">
                                        {% if q.is_published or q.is_active %}
                                            <a href="{{ url_for('admin.analytics', quiz_id=q.id) }}" class="btn action-btn text-dark w-100 mb-2" style="background-color: #f8f9fa; border: 1px solid #ddd;">
                                                <i class="fas fa-chart-bar me-2"></i>View Analytics
                                            </a>
                                        {% endif %}

                                        {% if q.is_active %}
                                            <a href="{{ url_for('admin.live_control', quiz_id=q.id) }}" class="btn action-btn btn-danger text-white w-100 mb-2">
                                                <i class="fas fa-broadcast-tower me-2"></i>üî¥ LIVE CONTROL
                                            </a>
                                            <a href="{{ url_for('admin.stop_quiz', quiz_id=q.id) }}" class="btn action-btn stop"><i class="fas fa-stop"></i> Stop</a>
                                        {% endif %}

                                        {% if not q.is_locked and not q.is_active and not q.is_published %}
                                            <a href="{{ url_for('admin.add_question', quiz_id=q.id) }}" class="btn action-btn edit"><i class="fas fa-edit"></i> Edit</a>
                                        {% endif %}

                                        {% if q.is_locked and not q.is_published and not q.is_active %}
                                            <a href="{{ url_for('admin.publish_quiz', quiz_id=q.id) }}" class="btn action-btn start"><i class="fas fa-play"></i> Publish</a>
                                        {% endif %}

                                        {% if q.is_published and not q.is_active %}
                                            <a href="{{ url_for('admin.start_quiz', quiz_id=q.id) }}" class="btn action-btn text-white w-100" style="background-color: #fd7e14;" onclick="return confirm('Are you sure you want to start this quiz for all students?')">
                                                <i class="fas fa-play me-2"></i>Start Quiz
                                            </a>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                             <div class="text-center p-5 w-100">
                                <p class="text-muted">No Timer-based quizzes found.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

<div class="modal fade" id="renameModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 24px; border: none; box-shadow: 0 20px 40px rgba(0,0,0,0.1);">
            <div class="modal-body p-4">
                <h5 class="fw-bold mb-4">Rename Quiz</h5>
                <form action="{{ url_for('admin.rename_quiz') }}" method="POST">
                    <input type="hidden" name="quiz_id" id="rename_quiz_id">
                    <div class="mb-3">
                        <label class="small text-muted mb-2">New Quiz Title</label>
                        <input type="text" name="new_title" id="rename_title" class="form-control custom-input" required>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-light w-100" style="border-radius: 12px; font-weight: 600;" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success-custom w-100">Update Title</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
function renameQuiz(id, title) {
    document.getElementById('rename_quiz_id').value = id;
    document.getElementById('rename_title').value = title;
    var myModal = new bootstrap.Modal(document.getElementById('renameModal'));
    myModal.show();
}

function copyJoinLink(link) {
    navigator.clipboard.writeText(link).then(() => {
        alert("‚úÖ Join link copied!");
    }).catch(() => {
        alert("‚ùå Copy failed");
    });
}
</script>
</body>
</html>